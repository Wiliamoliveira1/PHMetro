#include <Arduino.h>
#include <Wire.h>
#include <Adafruit_ADS1X15.h>

Adafruit_ADS1115 ads;

#define I2C_SDA 6
#define I2C_SCL 7

const int PH_CHANNEL = 0;
const int NUM_SAMPLES = 20;
const float GAIN = 6.144;
const float ADC_RESOLUTION = 32768.0;

// Vari√°veis de calibra√ß√£o
float t4 = NAN, t7 = NAN, t10 = NAN;
bool calibrado = false;

float a = 0, b = 0, c = 0;

float leituraParaTensao(int16_t leituraADC) {
  return (leituraADC * GAIN) / ADC_RESOLUTION;
}

void calcularCoeficientes() {
  // Usa os pontos (V, pH): (t4, 4), (t7, 7), (t10, 10)
  float x1 = t4, y1 = 4.0;
  float x2 = t7, y2 = 7.0;
  float x3 = t10, y3 = 10.0;

  float denom = (x1 - x2) * (x1 - x3) * (x2 - x3);

  a = (x3 * (y2 - y1) + x2 * (y1 - y3) + x1 * (y3 - y2)) / denom;
  b = (x3 * x3 * (y1 - y2) + x2 * x2 * (y3 - y1) + x1 * x1 * (y2 - y3)) / denom;
  c = (x2 * x3 * (x2 - x3) * y1 + x3 * x1 * (x3 - x1) * y2 + x1 * x2 * (x1 - x2) * y3) / denom;

  calibrado = true;

  Serial.println("\n‚úÖ Coeficientes de calibra√ß√£o atualizados:");
  Serial.print("a = "); Serial.println(a, 5);
  Serial.print("b = "); Serial.println(b, 5);
  Serial.print("c = "); Serial.println(c, 5);
}

float calcularPH(float tensao) {
  if (!calibrado) return -1;

  float pH = a * tensao * tensao + b * tensao + c;

  if (pH < 0) pH = 0;
  if (pH > 14) pH = 14;

  return pH;
}

void setup() {
  Serial.begin(115200);
  delay(1000);
  Wire.begin(I2C_SDA, I2C_SCL);

  if (!ads.begin(0x48, &Wire)) {
    Serial.println("‚ö†Ô∏è ADS1115 n√£o encontrado.");
    while (1);
  }

  ads.setGain(GAIN_TWOTHIRDS);
  Serial.println("üîß Sistema de calibra√ß√£o interativo iniciado.");
  Serial.println("Insira o sensor em uma solu√ß√£o e pressione:");
  Serial.println("  ‚û§ 'A' para calibrar pH 4");
  Serial.println("  ‚û§ 'B' para calibrar pH 7");
  Serial.println("  ‚û§ 'C' para calibrar pH 10");
}

void loop() {
  int32_t somaLeitura = 0;

  for (int i = 0; i < NUM_SAMPLES; i++) {
    somaLeitura += ads.readADC_SingleEnded(PH_CHANNEL);
    delay(10);
  }

  float mediaADC = somaLeitura / float(NUM_SAMPLES);
  float tensao = leituraParaTensao(mediaADC);

  // Checagem de comandos do usu√°rio
  if (Serial.available()) {
    char cmd = Serial.read();

    if (cmd == 'A' || cmd == 'a') {
      t4 = tensao;
      Serial.print("‚úÖ Calibra√ß√£o pH 4 registrada: ");
      Serial.print(t4, 4); Serial.println(" V");
    } else if (cmd == 'B' || cmd == 'b') {
      t7 = tensao;
      Serial.print("‚úÖ Calibra√ß√£o pH 7 registrada: ");
      Serial.print(t7, 4); Serial.println(" V");
    } else if (cmd == 'C' || cmd == 'c') {
      t10 = tensao;
      Serial.print("‚úÖ Calibra√ß√£o pH 10 registrada: ");
      Serial.print(t10, 4); Serial.println(" V");
    }

    if (!isnan(t4) && !isnan(t7) && !isnan(t10)) {
      calcularCoeficientes();
    }
  }

  Serial.print("Leitura m√©dia ADC: ");
  Serial.print(mediaADC);
  Serial.print(" | Tens√£o: ");
  Serial.print(tensao, 3);
  if (calibrado) {
    float ph = calcularPH(tensao);
    Serial.print(" V | pH: ");
    Serial.println(ph, 2);
  } else {
    Serial.println(" V | ‚ö†Ô∏è Ainda n√£o calibrado.");
  }

  delay(3000);
}
